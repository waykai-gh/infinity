# infinity-API documentation

> **Версия:** 2.0  
> **Дата обновления:** 2 января 2026  
> **Статус:** Актуальное руководство на основе реальных боевых серверов  
> **Проверено на:** Debian 12, Ubuntu 22.04, Ubuntu 24.04 с Xray v25.x

## Содержание

1. [Xray API](#xray-api)
2. [Telegram API](#telegram-api)
3. [Express API](#express-api)

## Xray API

**Xray API** - это gRPC интерфейс для управления Xray-сервером в реальном времени без перезагрузки службы. Это один из основных инструментов в сервисе, который используется для создания, удаления, просмотра трафика пользователей. 

### Архитектура Xray API на схеме:

```
┌──────────────────────────────────────────────────────┐
│              Xray Daemon (процесс)                   │
│                                                      │
│  ┌────────────────────────────────────────────┐      │
│  │  Main Service (VLESS на порту 8443)        │      │
│  │  • Обработка VPN трафика                   │      │
│  │  • VLESS + Reality шифрование              │      │
│  │  • Маршрутизация клиентов                  │      │
│  └────────────────────────────────────────────┘      │
│                                                      │
│  ┌────────────────────────────────────────────┐      │
│  │  API Service (gRPC на 127.0.0.1:10085)     │      │
│  │  ├─ HandlerService  (управление юзерами)   │      │
│  │  └─ StatsService    (статистика трафика)   │      │
│  └────────────────────────────────────────────┘      │
│                      ↕                               │
│  ┌────────────────────────────────────────────┐      │
│  │  Shared Memory (config в оперативке)       │      │
│  │  • clients[] массив пользователей          │      │
│  │  • stats[] счетчики трафика                │      │
│  └────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────┘
         ↑
         │ gRPC запросы
         │
┌────────┴──────────┐
│  Ваш бот/скрипт   │
│  (XtlsApi SDK)    │
└───────────────────┘
```

### Важно: Изменения происходят только в оперативной памяти. После перезапуска Xray они теряются!

### Почему это работает без перезагрузки:
Xray хранит конфигурацию в двух местах:

1. Файл config.json — начальная конфигурация при запуске

2. Оперативная память — активная конфигурация, которую использует daemon

API работает с оперативной памятью, поэтому изменения применяются мгновенно, но уходят после перезагрузки.

В рамках реализации Xray API в config.json добавляются специальные секции:
```bash
{
  "api": {
    "tag": "api",
    "services": ["HandlerService", "StatsService"]
  },
  
  "inbounds": [
    {
      "listen": "127.0.0.1",
      "port": 10085,
      "protocol": "dokodemo-door",
      "tag": "api"
    }
  ],
  
  "routing": {
    "rules": [
      {
        "inboundTag": ["api"],
        "outboundTag": "api",
        "type": "field"
      }
    ]
  }
}
```
**Это создает внутренний gRPC сервер на порту 10085.**


### Два основных сервиса который добавляет API:

1. HandlerService — управление пользователями:

   - AddUser() — добавить клиента в inbound

   - RemoveUser() — удалить клиента

   - AlterInbound() — изменить настройки inbound

2. StatsService — статистика:

   - GetStats() — получить uplink/downlink пользователя

   - QueryStats() — запросить счетчики с опцией сброса

### Как наглядно происходит добавление пользователя с помощью API:
```
Ваш код                    Xray API              Xray Daemon
─────────                  ─────────             ────────────
   │                          │                       │
   │ addVlessUser()           │                       │
   ├─────────────────────────>│                       │
   │  {uuid, email, flow}     │                       │
   │                          │  gRPC: AddUser        │
   │                          ├──────────────────────>│
   │                          │                       │
   │                          │              ┌────────┴────────┐
   │                          │              │ 1. Валидация    │
   │                          │              │ 2. Добавление в │
   │                          │              │    clients[]    │
   │                          │              │    в памяти     │
   │                          │              │ 3. НЕ трогает   │
   │                          │              │    config.json  │
   │                          │              └────────┬────────┘
   │                          │  Response: {isOk}     │
   │                          │<──────────────────────┤
   │ {isOk: true}             │                       │
   │<─────────────────────────┤                       │
   │                          │                       │
```

---
## Telegram API

**API telegram** - используется для управления telegram-ботами с помощью специального ключа который хранится в `.env` файле. **Токен должен быть засекречен и не должен показываться левым лицам!**

Файл `.env` **не** пушиться на удаленный репозиторий github! Он создается вручную на удаленном prod-сервере и далее в него добавляются переменные окружения, обязательно, с такими же названиями и значениями как в разработке

```bash
#создание файла:
nano .env
```

## Express API
